/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var U=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var ee=Object.prototype.hasOwnProperty;var te=(a,t)=>{for(var e in t)U(a,e,{get:t[e],enumerable:!0})},ie=(a,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Y(t))!ee.call(a,s)&&s!==e&&U(a,s,{get:()=>t[s],enumerable:!(i=X(t,s))||i.enumerable});return a};var se=a=>ie(U({},"__esModule",{value:!0}),a);var ge={};te(ge,{default:()=>z});module.exports=se(ge);var l=require("obsidian");function T(a){let t=new Date;return{...a,createdAt:t,updatedAt:t}}function V(a){return{...a,createdAt:a.createdAt.toISOString(),updatedAt:a.updatedAt.toISOString()}}function D(a){return{...a,createdAt:new Date(a.createdAt),updatedAt:new Date(a.updatedAt)}}function $(a){return[...a].sort((t,e)=>e.similarity-t.similarity)}function B(a,t){return a.slice(0,t)}async function f(a){let e=new TextEncoder().encode(a);try{let i=await crypto.subtle.digest("SHA-256",e);return`sha256:${Array.from(new Uint8Array(i)).map(o=>o.toString(16).padStart(2,"0")).join("")}`}catch(i){return`simple:${ne(a)}`}}function ne(a){let t=0;for(let e=0;e<a.length;e++){let i=a.charCodeAt(e);t=(t<<5)-t+i,t=t&t}return Math.abs(t).toString(16)}function E(a,t){return a===null||t===null?!1:a===t}var x=class{constructor(t,e,i){this.embeddingProvider=t;this.embeddingRepository=e;this.noteRepository=i}async execute(t,e){let i=e!=null?e:await this.noteRepository.findById(t);if(!i)throw new Error(`Note not found: ${t}`);let s=await f(i.content),n=await this.embeddingRepository.getContentHash(t);if(n&&E(n,s)){let d=await this.embeddingRepository.findById(t);if(d){let m=this.embeddingProvider.getProvider(),p=this.embeddingProvider.getModel();if(d.provider===m&&d.model===p)return{embedding:d,wasUpdated:!1,reason:"skipped"}}}let o=await this.embeddingProvider.embed(i.content),r=T({noteId:t,notePath:i.path,title:i.title,contentHash:s,vector:o,model:this.embeddingProvider.getModel(),provider:this.embeddingProvider.getProvider(),dimensions:this.embeddingProvider.getDimensions()});return await this.embeddingRepository.save(r),{embedding:r,wasUpdated:!0,reason:n?"stale":"new"}}async embedIfStale(t,e){let i=await this.embeddingRepository.getContentHash(t);return i&&E(i,e)?null:(await this.execute(t)).embedding}async forceEmbed(t){let e=await this.noteRepository.findById(t);if(!e)throw new Error(`Note not found: ${t}`);let i=await f(e.content),s=await this.embeddingProvider.embed(e.content),n=T({noteId:t,notePath:e.path,title:e.title,contentHash:i,vector:s,model:this.embeddingProvider.getModel(),provider:this.embeddingProvider.getProvider(),dimensions:this.embeddingProvider.getDimensions()});return await this.embeddingRepository.save(n),n}};var S=class{constructor(t,e){this.embeddingProvider=t;this.embeddingRepository=e}async execute(t,e){let{limit:i=10,threshold:s=.3,excludeNoteIds:n=[],excludeFolders:o=[]}=e||{},r=await this.embeddingProvider.embed(t),d=await this.embeddingRepository.findAll(),m=[];for(let y of d){if(n.includes(y.noteId)||o.some(k=>y.notePath.startsWith(k+"/")))continue;let b=this.cosineSimilarity(r,y.vector);b>=s&&m.push({noteId:y.noteId,notePath:y.notePath,title:y.title,similarity:b})}let p=$(m);return B(p,i)}async findSimilarToNote(t,e){let i=await this.embeddingRepository.findById(t);if(!i)throw new Error(`Embedding not found for note: ${t}`);let{limit:s=10,threshold:n=.3,excludeNoteIds:o=[],excludeFolders:r=[]}=e||{},d=[...o,t],m=await this.embeddingRepository.findAll(),p=[];for(let b of m){if(d.includes(b.noteId)||r.some(Q=>b.notePath.startsWith(Q+"/")))continue;let k=this.cosineSimilarity(i.vector,b.vector);k>=n&&p.push({noteId:b.noteId,notePath:b.notePath,title:b.title,similarity:k})}let y=$(p);return B(y,s)}cosineSimilarity(t,e){if(t.length!==e.length)throw new Error("Vector dimensions must match");let i=0,s=0,n=0;for(let r=0;r<t.length;r++)i+=t[r]*e[r],s+=t[r]*t[r],n+=e[r]*e[r];let o=Math.sqrt(s)*Math.sqrt(n);return o===0?0:i/o}};var A=class{constructor(t,e,i){this.embeddingProvider=t;this.embeddingRepository=e;this.noteRepository=i;this.embedNoteUseCase=new x(t,e,i),this.searchSimilarUseCase=new S(t,e)}isAvailable(){return this.embeddingProvider.isAvailable()}async embedNote(t){let e=await this.embedNoteUseCase.execute(t);return e.wasUpdated&&await this.embeddingRepository.updateIndexEntry(e.embedding),e}async embedNoteByPath(t){let e=await this.noteRepository.findByPath(t);if(!e)throw new Error(`Note not found at path: ${t}`);let i=await this.embedNoteUseCase.execute(e.noteId,e);return i.wasUpdated&&await this.embeddingRepository.updateIndexEntry(i.embedding),i}async embedAllNotes(t=[],e){let i=await this.noteRepository.findAllExcluding(t),s={total:i.length,completed:0,skipped:0,failed:0,currentNote:null};for(let n of i){s.currentNote=n.path,e==null||e(s);try{(await this.embedNoteUseCase.execute(n.noteId)).reason==="skipped"&&s.skipped++,s.completed++}catch(o){console.error(`Failed to embed ${n.path}:`,o),s.failed++}}return s.currentNote=null,e==null||e(s),await this.embeddingRepository.updateIndex(),{success:s.completed-s.skipped,skipped:s.skipped,failed:s.failed}}async embedStaleNotes(t=[],e){let i=await this.noteRepository.findAllExcluding(t),s={total:i.length,completed:0,skipped:0,failed:0,currentNote:null},n=0;for(let o of i){s.currentNote=o.path,e==null||e(s);try{let r=await f(o.content),d=await this.embeddingRepository.getContentHash(o.noteId);d&&E(d,r)?s.skipped++:(await this.embedNoteUseCase.execute(o.noteId),n++),s.completed++}catch(r){console.error(`Failed to embed ${o.path}:`,r),s.failed++}}return s.currentNote=null,e==null||e(s),await this.embeddingRepository.updateIndex(),{updated:n,skipped:s.skipped,failed:s.failed}}async searchSimilar(t,e){return this.searchSimilarUseCase.execute(t,e)}async findSimilarToNote(t,e){return this.searchSimilarUseCase.findSimilarToNote(t,e)}async getStats(){let t=await this.embeddingRepository.getIndex();return{totalEmbeddings:t.totalNotes,model:t.model||this.embeddingProvider.getModel(),provider:this.embeddingProvider.getProvider(),dimensions:t.dimensions||this.embeddingProvider.getDimensions(),lastUpdated:t.lastUpdated||null}}async deleteEmbedding(t){await this.embeddingRepository.delete(t),await this.embeddingRepository.updateIndex()}async clearAllEmbeddings(){await this.embeddingRepository.clear()}async hasEmbedding(t){return this.embeddingRepository.exists(t)}async getEmbedding(t){return this.embeddingRepository.findById(t)}};var M=require("obsidian"),j="https://api.openai.com/v1/embeddings",oe="text-embedding-3-small",re=1536,v=class{constructor(t,e=oe,i=re){this.apiKey=t;this.model=e,this.dimensions=i}async embed(t){return(await this.callOpenAI([t])).data[0].embedding}async embedBatch(t){let i=[];for(let s=0;s<t.length;s+=100){let n=t.slice(s,s+100),r=(await this.callOpenAI(n)).data.sort((d,m)=>d.index-m.index);i.push(...r.map(d=>d.embedding))}return i}isAvailable(){return!!this.apiKey&&this.apiKey.length>0}getModel(){return this.model}getProvider(){return"openai"}getDimensions(){return this.dimensions}async testApiKey(t){try{return(await(0,M.requestUrl)({url:j,method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,input:"test"})})).status===200}catch(e){return!1}}setApiKey(t){this.apiKey=t}async callOpenAI(t){if(!this.apiKey)throw new Error("OpenAI API key not configured");let e=t.map(i=>{let s=i.trim();return s.length>0?s:" "});try{let i=await(0,M.requestUrl)({url:j,method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,input:e})});if(i.status!==200)throw new Error(`OpenAI API error: ${i.status}`);return i.json}catch(i){throw i instanceof Error?new Error(`OpenAI embedding failed: ${i.message}`):i}}};var H=require("obsidian"),K="https://generativelanguage.googleapis.com/v1beta/models",ae="gemini-embedding-001",de=3072,I=class{constructor(t,e=ae,i=de){this.apiKey=t;this.model=e,this.dimensions=i}async embed(t){let e=t.trim()||" ";return(await this.callGoogle(`${K}/${this.model}:embedContent`,{content:{parts:[{text:e}]}})).embedding.values}async embedBatch(t){let i=[];for(let s=0;s<t.length;s+=100){let r=t.slice(s,s+100).map(m=>{let p=m.trim();return p.length>0?p:" "}).map(m=>({model:`models/${this.model}`,content:{parts:[{text:m}]}})),d=await this.callGoogle(`${K}/${this.model}:batchEmbedContents`,{requests:r});i.push(...d.embeddings.map(m=>m.values))}return i}isAvailable(){return!!this.apiKey&&this.apiKey.length>0}getModel(){return this.model}getProvider(){return"google"}getDimensions(){return this.dimensions}async testApiKey(t){try{return(await(0,H.requestUrl)({url:`${K}/${this.model}:embedContent`,method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":t},body:JSON.stringify({content:{parts:[{text:"test"}]}}),throw:!1})).status===200}catch(e){return!1}}setApiKey(t){this.apiKey=t}async callGoogle(t,e){if(!this.apiKey)throw new Error("Google API key not configured");try{let i=await(0,H.requestUrl)({url:t,method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":this.apiKey},body:JSON.stringify(e)});if(i.status!==200)throw new Error(`Google API error: ${i.status}`);return i.json}catch(i){throw i instanceof Error?new Error(`Google embedding failed: ${i.message}`):i}}};var _=require("obsidian"),q="https://api.voyageai.com/v1/embeddings",le="voyage-3.5-lite",me=1024,N=class{constructor(t,e=le,i=me){this.apiKey=t;this.model=e,this.dimensions=i}async embed(t){return(await this.callVoyageAI([t])).data[0].embedding}async embedBatch(t){let i=[];for(let s=0;s<t.length;s+=128){let n=t.slice(s,s+128),r=(await this.callVoyageAI(n)).data.sort((d,m)=>d.index-m.index);i.push(...r.map(d=>d.embedding))}return i}isAvailable(){return!!this.apiKey&&this.apiKey.length>0}getModel(){return this.model}getProvider(){return"voyageai"}getDimensions(){return this.dimensions}async testApiKey(t){try{return(await(0,_.requestUrl)({url:q,method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,input:["test"]})})).status===200}catch(e){return!1}}setApiKey(t){this.apiKey=t}async callVoyageAI(t){if(!this.apiKey)throw new Error("Voyage AI API key not configured");let e=t.map(i=>{let s=i.trim();return s.length>0?s:" "});try{let i=await(0,_.requestUrl)({url:q,method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,input:e})});if(i.status!==200)throw new Error(`Voyage AI API error: ${i.status}`);return i.json}catch(i){throw i instanceof Error?new Error(`Voyage AI embedding failed: ${i.message}`):i}}};var P={openai:{type:"openai",name:"OpenAI",defaultModel:"text-embedding-3-small",apiKeyPlaceholder:"sk-...",models:[{id:"text-embedding-3-small",name:"text-embedding-3-small (1536d)",dimensions:1536,maxBatchSize:100},{id:"text-embedding-3-large",name:"text-embedding-3-large (3072d)",dimensions:3072,maxBatchSize:100}]},google:{type:"google",name:"Google (Gemini)",defaultModel:"gemini-embedding-001",apiKeyPlaceholder:"AIza...",models:[{id:"gemini-embedding-001",name:"gemini-embedding-001 (3072d)",dimensions:3072,maxBatchSize:100},{id:"text-embedding-004",name:"text-embedding-004 (768d)",dimensions:768,maxBatchSize:100}]},voyageai:{type:"voyageai",name:"Voyage AI",defaultModel:"voyage-3.5-lite",apiKeyPlaceholder:"pa-...",models:[{id:"voyage-3.5-lite",name:"voyage-3.5-lite (1024d)",dimensions:1024,maxBatchSize:128},{id:"voyage-3.5",name:"voyage-3.5 (1024d)",dimensions:1024,maxBatchSize:128}]}};function w(a,t){var s;let e=P[a],i=e.models.find(n=>n.id===t);return(s=i==null?void 0:i.dimensions)!=null?s:e.models[0].dimensions}function L(a){return P[a].defaultModel}function h(a){switch(a.provider){case"openai":return a.openaiApiKey;case"google":return a.googleApiKey;case"voyageai":return a.voyageaiApiKey;default:return a.openaiApiKey}}function G(a){let t=h(a),{provider:e,model:i}=a,s=w(e,i);switch(e){case"openai":return new v(t,i,s);case"google":return new I(t,i,s);case"voyageai":return new N(t,i,s);default:return new v(t,i,s)}}var g=require("obsidian");var J="1.0.0",ce={storagePath:"09_Embedded",embeddingsFolder:"embeddings"},C=class{constructor(t,e){this.app=t;this.indexCache=null;this.config={...ce,...e}}async initialize(){let t=(0,g.normalizePath)(this.config.storagePath),e=(0,g.normalizePath)(`${t}/${this.config.embeddingsFolder}`);await this.ensureFolder(t),await this.ensureFolder(e);let i=this.getIndexPath();await this.fileExists(i)||await this.saveIndex(this.createEmptyIndex())}async save(t){let e=this.getEmbeddingPath(t.noteId),i=V(t),s=JSON.stringify(i,null,2);await this.writeFile(e,s),this.invalidateIndexCache()}async saveBatch(t){for(let i=0;i<t.length;i+=10){let s=t.slice(i,i+10);await Promise.all(s.map(n=>this.save(n)))}}async findById(t){let e=this.getEmbeddingPath(t);if(!await this.fileExists(e))return null;try{let i=await this.readFile(e),s=JSON.parse(i);return D(s)}catch(i){return null}}async findByPath(t){let e=await this.getIndex();for(let[i,s]of Object.entries(e.notes))if(s.path===t)return this.findById(i);return null}async findAll(){let t=await this.getIndex(),e=[];for(let i of Object.keys(t.notes)){let s=await this.findById(i);s&&e.push(s)}return e}async delete(t){let e=this.getEmbeddingPath(t);await this.deleteFile(e),this.invalidateIndexCache()}async exists(t){let e=this.getEmbeddingPath(t);return this.fileExists(e)}async getContentHash(t){var i;return((i=(await this.getIndex()).notes[t])==null?void 0:i.contentHash)||null}async updateIndex(){let t=(0,g.normalizePath)(`${this.config.storagePath}/${this.config.embeddingsFolder}`),e=this.app.vault.getAbstractFileByPath(t);if(!(e instanceof g.TFolder)){await this.saveIndex(this.createEmptyIndex());return}let i={},s="",n=0;for(let r of e.children)if(r instanceof g.TFile&&r.extension==="json")try{let d=await this.app.vault.read(r),m=D(JSON.parse(d));i[m.noteId]={path:m.notePath,contentHash:m.contentHash,updatedAt:m.updatedAt.toISOString()},s||(s=m.model),n||(n=m.dimensions)}catch(d){}let o={version:J,totalNotes:Object.keys(i).length,lastUpdated:new Date().toISOString(),model:s,dimensions:n,notes:i};await this.saveIndex(o)}async updateIndexEntry(t){let e=await this.getIndex();e.notes[t.noteId]={path:t.notePath,contentHash:t.contentHash,updatedAt:t.updatedAt.toISOString()},e.totalNotes=Object.keys(e.notes).length,e.lastUpdated=new Date().toISOString(),e.model||(e.model=t.model),e.dimensions||(e.dimensions=t.dimensions),await this.saveIndex(e)}async getIndex(){if(this.indexCache)return this.indexCache;let t=this.getIndexPath();if(!await this.fileExists(t)){let e=this.createEmptyIndex();return this.indexCache=e,e}try{let e=await this.readFile(t),i=JSON.parse(e);return this.indexCache=i,i}catch(e){let i=this.createEmptyIndex();return this.indexCache=i,i}}async count(){return(await this.getIndex()).totalNotes}async clear(){let t=(0,g.normalizePath)(`${this.config.storagePath}/${this.config.embeddingsFolder}`),e=this.app.vault.getAbstractFileByPath(t);if(e instanceof g.TFolder)for(let i of e.children)i instanceof g.TFile&&await this.app.vault.delete(i);await this.saveIndex(this.createEmptyIndex())}getIndexPath(){return(0,g.normalizePath)(`${this.config.storagePath}/index.json`)}getEmbeddingPath(t){let e=t.replace(/[^a-zA-Z0-9-_]/g,"_");return(0,g.normalizePath)(`${this.config.storagePath}/${this.config.embeddingsFolder}/${e}.json`)}createEmptyIndex(){return{version:J,totalNotes:0,lastUpdated:new Date().toISOString(),model:"",dimensions:0,notes:{}}}async saveIndex(t){let e=this.getIndexPath(),i=JSON.stringify(t,null,2);await this.writeFile(e,i),this.indexCache=t}invalidateIndexCache(){this.indexCache=null}async ensureFolder(t){let e=this.app.vault.getAbstractFileByPath(t);if(!(e instanceof g.TFolder)){if(e instanceof g.TFile)throw new Error(`Path exists as file, expected folder: ${t}`);try{await this.app.vault.createFolder(t)}catch(i){let s=i instanceof Error?i.message:String(i);if(s.toLowerCase().includes("already exists")||s.toLowerCase().includes("folder already exists")){console.log(`Vault Embeddings: Folder already exists (sync OK): ${t}`);return}if(await this.delay(100),this.app.vault.getAbstractFileByPath(t)instanceof g.TFolder){console.log(`Vault Embeddings: Folder exists after retry: ${t}`);return}throw new Error(`Failed to create folder: ${t} - ${s}`)}}}delay(t){return new Promise(e=>setTimeout(e,t))}async fileExists(t){if(this.app.vault.getAbstractFileByPath(t)instanceof g.TFile)return!0;try{return await this.app.vault.adapter.exists(t)}catch(i){return!1}}async readFile(t){let e=this.app.vault.getAbstractFileByPath(t);if(e instanceof g.TFile)return this.app.vault.read(e);try{let i=await this.app.vault.adapter.read(t);return console.log(`Vault Embeddings: Used adapter.read for: ${t}`),i}catch(i){throw new Error(`File not found: ${t}`)}}async writeFile(t,e){let i=this.app.vault.getAbstractFileByPath(t);if(i instanceof g.TFile){await this.app.vault.modify(i,e);return}try{await this.app.vault.create(t,e)}catch(s){let n=s instanceof Error?s.message:String(s);if(n.toLowerCase().includes("already exists")||n.toLowerCase().includes("file already exists")){console.log(`Vault Embeddings: File already exists, retrying with modify: ${t}`),await this.delay(100);let o=this.app.vault.getAbstractFileByPath(t);if(o instanceof g.TFile){await this.app.vault.modify(o,e);return}await this.app.vault.adapter.write(t,e),console.log(`Vault Embeddings: Used adapter.write for: ${t}`);return}throw s}}async deleteFile(t){let e=this.app.vault.getAbstractFileByPath(t);e instanceof g.TFile&&await this.app.vault.delete(e)}};var u=require("obsidian"),R=class{constructor(t){this.app=t}async findById(t){let e=this.app.vault.getMarkdownFiles();for(let i of e)if(this.generateNoteId(i.path)===t)return this.fileToNoteContent(i);return null}async findByPath(t){let e=(0,u.normalizePath)(t),i=this.app.vault.getAbstractFileByPath(e);return i instanceof u.TFile?this.fileToNoteContent(i):null}async findAllMarkdownNotes(){let t=this.app.vault.getMarkdownFiles(),e=[];for(let i of t){let s=await this.fileToNoteContent(i);s&&e.push(s)}return e}async findByFolder(t){let e=this.app.vault.getMarkdownFiles(),i=[],s=(0,u.normalizePath)(t);for(let n of e)if((0,u.normalizePath)(n.path).startsWith(s+"/")){let r=await this.fileToNoteContent(n);r&&i.push(r)}return i}async findAllExcluding(t){let e=this.app.vault.getMarkdownFiles(),i=[],s=t.map(n=>(0,u.normalizePath)(n));for(let n of e){let o=(0,u.normalizePath)(n.path);if(!s.some(d=>o.startsWith(d+"/")||o===d)){let d=await this.fileToNoteContent(n);d&&i.push(d)}}return i}async exists(t){return await this.findById(t)!==null}generateNoteId(t){let i=(0,u.normalizePath)(t).replace(/\.md$/,"");return this.simpleHash(i)}async fileToNoteContent(t){try{let e=await this.app.vault.cachedRead(t),i=(0,u.normalizePath)(t.path);return{noteId:this.generateNoteId(t.path),path:i,title:t.basename,content:e,modifiedAt:new Date(t.stat.mtime)}}catch(e){return null}}simpleHash(t){let e=0;for(let i=0;i<t.length;i++){let s=t.charCodeAt(i);e=(e<<5)-e+s,e=e&e}return Math.abs(e).toString(16).padStart(8,"0")}};var W={openaiApiKey:"",provider:"openai",googleApiKey:"",voyageaiApiKey:"",storagePath:"09_Embedded",excludedFolders:["06_Meta","Templates"],autoEmbed:!0,autoEmbedDelay:5e3,model:"text-embedding-3-small"};var c=require("obsidian");var Z=require("obsidian"),F=class extends Z.Modal{constructor(e,i){super(e);this.progressEl=null;this.progressFillEl=null;this.progressStatusEl=null;this.progressPercentEl=null;this.closeBtn=null;this.modalTitle=i}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("vault-embeddings-progress-modal"),e.createEl("h2",{text:this.modalTitle}),this.progressEl=e.createDiv({cls:"progress-section"}),this.createProgressUI();let i=e.createDiv({cls:"progress-buttons"});i.style.marginTop="20px",i.style.textAlign="center",this.closeBtn=i.createEl("button",{text:"Close"}),this.closeBtn.disabled=!0,this.closeBtn.addEventListener("click",()=>this.close())}createProgressUI(){if(!this.progressEl)return;this.progressEl.empty();let e=this.progressEl.createDiv({cls:"progress-container"});e.style.marginTop="15px",this.progressStatusEl=e.createEl("p",{text:"Preparing..."}),this.progressStatusEl.style.marginBottom="10px";let i=e.createDiv({cls:"progress-bar"});i.style.width="100%",i.style.height="20px",i.style.backgroundColor="var(--background-modifier-border)",i.style.borderRadius="10px",i.style.overflow="hidden",i.style.position="relative",this.progressFillEl=i.createDiv({cls:"progress-fill"}),this.progressFillEl.setCssStyles({width:"0%",height:"100%",backgroundColor:"var(--interactive-accent)",transition:"width 0.3s ease",position:"absolute",left:"0",top:"0"}),this.progressPercentEl=e.createEl("p",{text:"0%"}),this.progressPercentEl.style.textAlign="center",this.progressPercentEl.style.marginTop="10px"}updateProgress(e){this.progressFillEl&&this.progressFillEl.setCssStyles({width:`${e.percentage}%`}),this.progressStatusEl&&(this.progressStatusEl.textContent=e.message),this.progressPercentEl&&(this.progressPercentEl.textContent=`${e.current} / ${e.total} (${e.percentage}%)`)}setComplete(e){this.progressStatusEl&&(this.progressStatusEl.textContent=e),this.progressFillEl&&this.progressFillEl.setCssStyles({width:"100%",backgroundColor:"var(--interactive-success)"}),this.progressPercentEl&&(this.progressPercentEl.textContent="100%"),this.closeBtn&&(this.closeBtn.disabled=!1,this.closeBtn.focus())}setError(e){this.progressStatusEl&&(this.progressStatusEl.textContent=e,this.progressStatusEl.style.color="var(--text-error)"),this.progressFillEl&&this.progressFillEl.setCssStyles({backgroundColor:"var(--text-error)"}),this.closeBtn&&(this.closeBtn.disabled=!1,this.closeBtn.focus())}onClose(){this.contentEl.empty()}};var O=class extends c.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Vault Embeddings Settings"}),this.displayMismatchWarning(t),t.createEl("h3",{text:"API Settings"}),new c.Setting(t).setName("Embedding Provider").setDesc("Select the embedding provider to use").addDropdown(s=>{for(let[n,o]of Object.entries(P))s.addOption(n,o.name);s.setValue(this.plugin.settings.provider),s.onChange(async n=>{let o=n;this.plugin.settings.provider=o,this.plugin.settings.model=L(o),await this.plugin.saveSettings(),this.display()})});let e=P[this.plugin.settings.provider];new c.Setting(t).setName(`${e.name} API Key`).setDesc(`API key for ${e.name} embeddings`).addText(s=>{s.setPlaceholder(e.apiKeyPlaceholder).setValue(h(this.plugin.settings)).onChange(async n=>{switch(this.plugin.settings.provider){case"openai":this.plugin.settings.openaiApiKey=n;break;case"google":this.plugin.settings.googleApiKey=n;break;case"voyageai":this.plugin.settings.voyageaiApiKey=n;break}await this.plugin.saveSettings()}),s.inputEl.type="password",s.inputEl.style.width="300px"}).addButton(s=>{s.setButtonText("Test").onClick(async()=>{if(!h(this.plugin.settings)){new c.Notice("Please enter an API key first");return}s.setDisabled(!0),s.setButtonText("Testing...");try{await this.plugin.testApiKey()?new c.Notice("API key is valid!"):new c.Notice("API key is invalid")}catch(n){new c.Notice("Test failed: "+(n instanceof Error?n.message:"Unknown error"))}finally{s.setDisabled(!1),s.setButtonText("Test")}})}),new c.Setting(t).setName("Embedding Model").setDesc("Select the model to use for generating embeddings").addDropdown(s=>{for(let n of e.models)s.addOption(n.id,n.name);s.setValue(this.plugin.settings.model),s.onChange(async n=>{this.plugin.settings.model=n,await this.plugin.saveSettings(),this.display()})}),t.createEl("h3",{text:"Storage Settings"}),new c.Setting(t).setName("Storage Folder").setDesc("Folder to store embedding data (will be created if not exists)").addText(s=>s.setPlaceholder("09_Embedded").setValue(this.plugin.settings.storagePath).onChange(async n=>{this.plugin.settings.storagePath=n||"09_Embedded",await this.plugin.saveSettings()})),new c.Setting(t).setName("Excluded Folders").setDesc("Folders to exclude from embedding (comma-separated)").addText(s=>s.setPlaceholder("06_Meta, Templates").setValue(this.plugin.settings.excludedFolders.join(", ")).onChange(async n=>{this.plugin.settings.excludedFolders=n.split(",").map(o=>o.trim()).filter(o=>o.length>0),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Auto Embedding"}),new c.Setting(t).setName("Auto Embed").setDesc("Automatically create/update embeddings when notes are created or modified").addToggle(s=>s.setValue(this.plugin.settings.autoEmbed).onChange(async n=>{this.plugin.settings.autoEmbed=n,await this.plugin.saveSettings()})),new c.Setting(t).setName("Auto Embed Delay").setDesc("Delay before auto-embedding after modification (in seconds)").addSlider(s=>s.setLimits(1,30,1).setValue(this.plugin.settings.autoEmbedDelay/1e3).setDynamicTooltip().onChange(async n=>{this.plugin.settings.autoEmbedDelay=n*1e3,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Actions"}),new c.Setting(t).setName("Embed All Notes").setDesc("Generate embeddings for all notes in the vault").addButton(s=>{s.setButtonText("Embed All").setCta().onClick(async()=>{if(!this.plugin.isConfigured()){new c.Notice("Please configure API key first");return}let n=new F(this.app,"Embedding All Notes");n.open();try{let o=await this.plugin.embedAllNotes(r=>{let d=r.completed+r.failed,m=r.completed-r.skipped,p=r.total>0?Math.round(d/r.total*100):0;n.updateProgress({current:d,total:r.total,message:`Processing: ${m} / ${d} (${r.skipped} skipped, ${r.failed} failed)`,percentage:p})});n.setComplete(`Complete! ${o.success} embedded, ${o.skipped} skipped, ${o.failed} failed`)}catch(o){let r=o instanceof Error?o.message:"Unknown error";n.setError(`Failed: ${r}`)}})}),new c.Setting(t).setName("Update Stale Embeddings").setDesc("Only update embeddings for modified notes").addButton(s=>{s.setButtonText("Update Stale").onClick(async()=>{if(!this.plugin.isConfigured()){new c.Notice("Please configure API key first");return}let n=new F(this.app,"Updating Stale Embeddings");n.open();try{let o=await this.plugin.embedStaleNotes(r=>{let d=r.completed+r.failed,m=r.completed-r.skipped,p=r.total>0?Math.round(d/r.total*100):0;n.updateProgress({current:d,total:r.total,message:`Checking: ${m} updated / ${d} checked (${r.skipped} unchanged)`,percentage:p})});n.setComplete(`Complete! ${o.updated} updated, ${o.skipped} skipped, ${o.failed} failed`)}catch(o){let r=o instanceof Error?o.message:"Unknown error";n.setError(`Failed: ${r}`)}})}),new c.Setting(t).setName("Clear All Embeddings").setDesc("Delete all stored embeddings").addButton(s=>{s.setButtonText("Clear All").setWarning().onClick(async()=>{if(confirm("Are you sure you want to delete all embeddings?"))try{await this.plugin.clearAllEmbeddings(),new c.Notice("All embeddings cleared")}catch(o){new c.Notice("Clear failed: "+(o instanceof Error?o.message:"Unknown error"))}})}),t.createEl("h3",{text:"Statistics"});let i=t.createDiv({cls:"vault-embeddings-stats"});this.displayStats(i)}async displayMismatchWarning(t){try{let e=await this.plugin.hasProviderMismatch();if(e.mismatch){let i=t.createDiv({cls:"vault-embeddings-mismatch-warning"});i.style.padding="12px",i.style.marginBottom="12px",i.style.backgroundColor="var(--background-modifier-error)",i.style.borderRadius="8px",i.style.color="var(--text-on-accent)",i.createEl("strong",{text:"Dimension Mismatch Warning"}),i.createEl("p",{text:`Stored embeddings use ${e.storedDimensions}d vectors. Current provider/model uses ${e.currentDimensions}d. Run "Embed All" to re-embed all notes with the new provider.`});let s=t.querySelector("h2");s&&s.nextSibling&&t.insertBefore(i,s.nextSibling)}}catch(e){}}async displayStats(t){t.empty();try{let e=await this.plugin.getStats();t.createEl("p",{text:`Total embeddings: ${e.totalEmbeddings}`}),t.createEl("p",{text:`Model: ${e.model||"Not set"}`}),t.createEl("p",{text:`Provider: ${e.provider||"Not set"}`}),t.createEl("p",{text:`Dimensions: ${e.dimensions||"Not set"}`}),t.createEl("p",{text:`Last updated: ${e.lastUpdated||"Never"}`})}catch(e){t.createEl("p",{text:"Unable to load statistics"})}}};var z=class extends l.Plugin{constructor(){super(...arguments);this.embeddingProvider=null;this.embeddingRepository=null;this.noteRepository=null;this.embeddingService=null;this.pendingAutoEmbedFiles=new Map;this.processAutoEmbedDebounced=null;this.autoEmbedProcessing=!1;this.initError=null}async onload(){console.log("Loading Vault Embeddings Plugin"),await this.loadSettings(),await this.initializeServices(),this.addCommand({id:"embed-current-note",name:"Embed current note",callback:()=>this.embedCurrentNote()}),this.addCommand({id:"embed-all-notes",name:"Embed all notes",callback:()=>this.embedAllNotesCommand()}),this.addCommand({id:"update-stale-embeddings",name:"Update stale embeddings",callback:()=>this.updateStaleCommand()}),this.addCommand({id:"show-embedding-stats",name:"Show embedding statistics",callback:()=>this.showStatsCommand()}),this.addSettingTab(new O(this.app,this)),this.registerVaultEvents(),this.addRibbonIcon("database","Vault Embeddings",()=>{this.showStatsCommand()})}async onunload(){console.log("Unloading Vault Embeddings Plugin"),this.processAutoEmbedDebounced=null,this.pendingAutoEmbedFiles.clear(),this.autoEmbedProcessing=!1,this.embeddingService=null,this.embeddingRepository=null,this.embeddingProvider=null,this.noteRepository=null}async loadSettings(){this.settings=Object.assign({},W,await this.loadData())}async saveSettings(){await this.saveData(this.settings),await this.initializeServices()}getInitError(){return this.initError}async initializeServices(){if(this.initError=null,!h(this.settings)){console.log("Vault Embeddings: API key not configured"),this.initError="API key not configured",new l.Notice("Vault Embeddings: API key not configured. Set it in Settings \u2192 Vault Embeddings.");return}try{console.log("Vault Embeddings: Initializing provider..."),this.embeddingProvider=G(this.settings),console.log("Vault Embeddings: Provider initialized"),console.log("Vault Embeddings: Creating repository..."),this.embeddingRepository=new C(this.app,{storagePath:this.settings.storagePath}),console.log("Vault Embeddings: Initializing storage...");try{await this.embeddingRepository.initialize(),console.log("Vault Embeddings: Storage initialized")}catch(e){let i=e instanceof Error?e.message:"Unknown storage error";console.error("Vault Embeddings: Storage initialization failed:",i),this.initError=`Storage initialization failed: ${i}`,new l.Notice(`Vault Embeddings: Storage initialization failed \u2014 ${i}`);return}this.noteRepository=new R(this.app),this.embeddingService=new A(this.embeddingProvider,this.embeddingRepository,this.noteRepository),this.setupAutoEmbed(),console.log("Vault Embeddings: All services initialized successfully")}catch(e){let i=e instanceof Error?e.message:"Unknown error";console.error("Vault Embeddings: Failed to initialize services:",i),this.initError=i}}setupAutoEmbed(){this.processAutoEmbedDebounced&&(this.processAutoEmbedDebounced=null),this.pendingAutoEmbedFiles.clear(),this.settings.autoEmbed&&this.embeddingService&&(this.processAutoEmbedDebounced=(0,l.debounce)(()=>{this.processAutoEmbedQueue()},this.settings.autoEmbedDelay,!1))}async processAutoEmbedQueue(){if(!(!this.embeddingService||!this.noteRepository)){if(this.autoEmbedProcessing){this.pendingAutoEmbedFiles.size>0&&this.processAutoEmbedDebounced&&this.processAutoEmbedDebounced();return}this.autoEmbedProcessing=!0;try{let e=new Map(this.pendingAutoEmbedFiles);this.pendingAutoEmbedFiles.clear();for(let[,i]of e){let s=(0,l.normalizePath)(i.path);if(!this.settings.excludedFolders.some(o=>s.startsWith((0,l.normalizePath)(o)+"/")))try{await this.embeddingService.embedNoteByPath(i.path),console.log(`Auto-embedded: ${i.path}`)}catch(o){console.error(`Auto-embed failed for ${i.path}:`,o)}}}finally{this.autoEmbedProcessing=!1,this.pendingAutoEmbedFiles.size>0&&this.processAutoEmbedDebounced&&this.processAutoEmbedDebounced()}}}registerVaultEvents(){this.registerEvent(this.app.vault.on("modify",e=>{e instanceof l.TFile&&e.extension==="md"&&this.processAutoEmbedDebounced&&(this.pendingAutoEmbedFiles.set(e.path,e),this.processAutoEmbedDebounced())})),this.registerEvent(this.app.vault.on("create",e=>{e instanceof l.TFile&&e.extension==="md"&&this.processAutoEmbedDebounced&&(this.pendingAutoEmbedFiles.set(e.path,e),this.processAutoEmbedDebounced())})),this.registerEvent(this.app.vault.on("delete",async e=>{if(e instanceof l.TFile&&e.extension==="md"&&this.embeddingService&&this.noteRepository)try{let i=this.noteRepository.generateNoteId(e.path);await this.embeddingService.deleteEmbedding(i),console.log(`Deleted embedding: ${e.path}`)}catch(i){console.error(`Failed to delete embedding for ${e.path}:`,i)}})),this.registerEvent(this.app.vault.on("rename",async(e,i)=>{if(e instanceof l.TFile&&e.extension==="md"&&this.embeddingService&&this.noteRepository)try{let s=this.noteRepository.generateNoteId(i);await this.embeddingService.deleteEmbedding(s),this.processAutoEmbedDebounced&&(this.pendingAutoEmbedFiles.set(e.path,e),this.processAutoEmbedDebounced())}catch(s){console.error(`Failed to handle rename for ${e.path}:`,s)}}))}isConfigured(){return!!h(this.settings)&&!!this.embeddingService}async testApiKey(){return this.embeddingProvider?this.embeddingProvider.testApiKey(h(this.settings)):!1}async embedAllNotes(e){if(!this.embeddingService)throw new Error("Embedding service not initialized");return this.embeddingService.embedAllNotes(this.settings.excludedFolders,e)}async embedStaleNotes(e){if(!this.embeddingService)throw new Error("Embedding service not initialized");return this.embeddingService.embedStaleNotes(this.settings.excludedFolders,e)}async clearAllEmbeddings(){if(!this.embeddingService)throw new Error("Embedding service not initialized");await this.embeddingService.clearAllEmbeddings()}async getStats(){return this.embeddingService?this.embeddingService.getStats():{totalEmbeddings:0,model:this.settings.model,provider:this.settings.provider,dimensions:w(this.settings.provider,this.settings.model),lastUpdated:null}}async hasProviderMismatch(){let e=await this.getStats();if(e.totalEmbeddings===0)return{mismatch:!1};let i=w(this.settings.provider,this.settings.model);return e.dimensions&&e.dimensions!==i?{mismatch:!0,storedDimensions:e.dimensions,currentDimensions:i}:{mismatch:!1}}async embedQuery(e){if(!this.embeddingProvider)throw new Error("Embedding provider not initialized");return this.embeddingProvider.embed(e)}getProviderInfo(){return this.embeddingProvider?{provider:this.embeddingProvider.getProvider(),model:this.embeddingProvider.getModel(),dimensions:this.embeddingProvider.getDimensions()}:null}async searchSimilar(e,i){return this.embeddingService?this.embeddingService.searchSimilar(e,i):[]}async findSimilarToNote(e,i){if(!this.embeddingService||!this.noteRepository)return[];let s=this.noteRepository.generateNoteId(e);return this.embeddingService.findSimilarToNote(s,i)}async embedCurrentNote(){if(!this.embeddingService||!this.noteRepository){new l.Notice("Embedding service not configured");return}let e=this.app.workspace.getActiveFile();if(!e||e.extension!=="md"){new l.Notice("No markdown file active");return}try{(await this.embeddingService.embedNoteByPath(e.path)).wasUpdated?new l.Notice(`Embedded: ${e.basename}`):new l.Notice(`Already up to date: ${e.basename}`)}catch(i){new l.Notice("Embedding failed: "+(i instanceof Error?i.message:"Unknown error"))}}async embedAllNotesCommand(){if(!this.isConfigured()){let e=this.getInitError();e?new l.Notice(`Configuration error: ${e}`):new l.Notice("Please configure API key first");return}new l.Notice("Starting embedding...");try{let e=await this.embedAllNotes(i=>{console.log(`Progress: ${i.completed}/${i.total}`)});new l.Notice(`Complete! ${e.success} embedded, ${e.skipped} skipped, ${e.failed} failed`)}catch(e){new l.Notice("Embedding failed: "+(e instanceof Error?e.message:"Unknown error"))}}async updateStaleCommand(){if(!this.isConfigured()){new l.Notice("Please configure API key first");return}new l.Notice("Updating stale embeddings...");try{let e=await this.embedStaleNotes();new l.Notice(`Complete! ${e.updated} updated, ${e.skipped} skipped, ${e.failed} failed`)}catch(e){new l.Notice("Update failed: "+(e instanceof Error?e.message:"Unknown error"))}}async showStatsCommand(){let e=await this.getStats();new l.Notice(`Embeddings: ${e.totalEmbeddings}
Model: ${e.model}
Last updated: ${e.lastUpdated||"Never"}`)}};
