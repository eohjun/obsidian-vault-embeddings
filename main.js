/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var T=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var _=(r,t)=>{for(var e in t)T(r,e,{get:t[e],enumerable:!0})},j=(r,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of K(t))!L.call(r,s)&&s!==e&&T(r,s,{get:()=>t[s],enumerable:!(i=z(t,s))||i.enumerable});return r};var q=r=>j(T({},"__esModule",{value:!0}),r);var Z={};_(Z,{default:()=>F});module.exports=q(Z);var d=require("obsidian");function I(r){let t=new Date;return{...r,createdAt:t,updatedAt:t}}function $(r){return{...r,createdAt:r.createdAt.toISOString(),updatedAt:r.updatedAt.toISOString()}}function A(r){return{...r,createdAt:new Date(r.createdAt),updatedAt:new Date(r.updatedAt)}}function C(r){return[...r].sort((t,e)=>e.similarity-t.similarity)}function R(r,t){return r.slice(0,t)}async function u(r){let e=new TextEncoder().encode(r);try{let i=await crypto.subtle.digest("SHA-256",e);return`sha256:${Array.from(new Uint8Array(i)).map(n=>n.toString(16).padStart(2,"0")).join("")}`}catch(i){return`simple:${J(r)}`}}function J(r){let t=0;for(let e=0;e<r.length;e++){let i=r.charCodeAt(e);t=(t<<5)-t+i,t=t&t}return Math.abs(t).toString(16)}function b(r,t){return r===null||t===null?!1:r===t}var f=class{constructor(t,e,i){this.embeddingProvider=t;this.embeddingRepository=e;this.noteRepository=i}async execute(t){let e=await this.noteRepository.findById(t);if(!e)throw new Error(`Note not found: ${t}`);let i=await u(e.content),s=await this.embeddingRepository.getContentHash(t);if(s&&b(s,i)){let a=await this.embeddingRepository.findById(t);if(a)return{embedding:a,wasUpdated:!1,reason:"skipped"}}let o=await this.embeddingProvider.embed(e.content),n=I({noteId:t,notePath:e.path,title:e.title,contentHash:i,vector:o,model:this.embeddingProvider.getModel(),provider:this.embeddingProvider.getProvider(),dimensions:this.embeddingProvider.getDimensions()});return await this.embeddingRepository.save(n),{embedding:n,wasUpdated:!0,reason:s?"stale":"new"}}async embedIfStale(t,e){let i=await this.embeddingRepository.getContentHash(t);return i&&b(i,e)?null:(await this.execute(t)).embedding}async forceEmbed(t){let e=await this.noteRepository.findById(t);if(!e)throw new Error(`Note not found: ${t}`);let i=await u(e.content),s=await this.embeddingProvider.embed(e.content),o=I({noteId:t,notePath:e.path,title:e.title,contentHash:i,vector:s,model:this.embeddingProvider.getModel(),provider:this.embeddingProvider.getProvider(),dimensions:this.embeddingProvider.getDimensions()});return await this.embeddingRepository.save(o),o}};var y=class{constructor(t,e){this.embeddingProvider=t;this.embeddingRepository=e}async execute(t,e){let{limit:i=10,threshold:s=.3,excludeNoteIds:o=[],excludeFolders:n=[]}=e||{},a=await this.embeddingProvider.embed(t),c=await this.embeddingRepository.findAll(),m=[];for(let h of c){if(o.includes(h.noteId)||n.some(N=>h.notePath.startsWith(N+"/")))continue;let g=this.cosineSimilarity(a,h.vector);g>=s&&m.push({noteId:h.noteId,notePath:h.notePath,title:h.title,similarity:g})}let S=C(m);return R(S,i)}async findSimilarToNote(t,e){let i=await this.embeddingRepository.findById(t);if(!i)throw new Error(`Embedding not found for note: ${t}`);let{limit:s=10,threshold:o=.3,excludeNoteIds:n=[],excludeFolders:a=[]}=e||{},c=[...n,t],m=await this.embeddingRepository.findAll(),S=[];for(let g of m){if(c.includes(g.noteId)||a.some(M=>g.notePath.startsWith(M+"/")))continue;let N=this.cosineSimilarity(i.vector,g.vector);N>=o&&S.push({noteId:g.noteId,notePath:g.notePath,title:g.title,similarity:N})}let h=C(S);return R(h,s)}cosineSimilarity(t,e){if(t.length!==e.length)throw new Error("Vector dimensions must match");let i=0,s=0,o=0;for(let a=0;a<t.length;a++)i+=t[a]*e[a],s+=t[a]*t[a],o+=e[a]*e[a];let n=Math.sqrt(s)*Math.sqrt(o);return n===0?0:i/n}};var E=class{constructor(t,e,i){this.embeddingProvider=t;this.embeddingRepository=e;this.noteRepository=i;this.embedNoteUseCase=new f(t,e,i),this.searchSimilarUseCase=new y(t,e)}isAvailable(){return this.embeddingProvider.isAvailable()}async embedNote(t){return this.embedNoteUseCase.execute(t)}async embedAllNotes(t=[],e){let i=await this.noteRepository.findAllExcluding(t),s={total:i.length,completed:0,skipped:0,failed:0,currentNote:null};for(let o of i){s.currentNote=o.path,e==null||e(s);try{(await this.embedNoteUseCase.execute(o.noteId)).reason==="skipped"&&s.skipped++,s.completed++}catch(n){console.error(`Failed to embed ${o.path}:`,n),s.failed++}}return s.currentNote=null,e==null||e(s),await this.embeddingRepository.updateIndex(),{success:s.completed-s.skipped,skipped:s.skipped,failed:s.failed}}async embedStaleNotes(t=[],e){let i=await this.noteRepository.findAllExcluding(t),s={total:i.length,completed:0,skipped:0,failed:0,currentNote:null},o=0;for(let n of i){s.currentNote=n.path,e==null||e(s);try{let a=await u(n.content),c=await this.embeddingRepository.getContentHash(n.noteId);c&&b(c,a)?s.skipped++:(await this.embedNoteUseCase.execute(n.noteId),o++),s.completed++}catch(a){console.error(`Failed to embed ${n.path}:`,a),s.failed++}}return s.currentNote=null,e==null||e(s),await this.embeddingRepository.updateIndex(),{updated:o,skipped:s.skipped,failed:s.failed}}async searchSimilar(t,e){return this.searchSimilarUseCase.execute(t,e)}async findSimilarToNote(t,e){return this.searchSimilarUseCase.findSimilarToNote(t,e)}async getStats(){let t=await this.embeddingRepository.getIndex();return{totalEmbeddings:t.totalNotes,model:t.model||this.embeddingProvider.getModel(),provider:this.embeddingProvider.getProvider(),dimensions:t.dimensions||this.embeddingProvider.getDimensions(),lastUpdated:t.lastUpdated||null}}async deleteEmbedding(t){await this.embeddingRepository.delete(t),await this.embeddingRepository.updateIndex()}async clearAllEmbeddings(){await this.embeddingRepository.clear()}async hasEmbedding(t){return this.embeddingRepository.exists(t)}async getEmbedding(t){return this.embeddingRepository.findById(t)}};var B=require("obsidian"),D="https://api.openai.com/v1/embeddings",W="text-embedding-3-small",G=1536,v=class{constructor(t,e=W,i=G){this.apiKey=t;this.model=e,this.dimensions=i}async embed(t){return(await this.callOpenAI([t])).data[0].embedding}async embedBatch(t){let i=[];for(let s=0;s<t.length;s+=100){let o=t.slice(s,s+100),a=(await this.callOpenAI(o)).data.sort((c,m)=>c.index-m.index);i.push(...a.map(c=>c.embedding))}return i}isAvailable(){return!!this.apiKey&&this.apiKey.length>0}getModel(){return this.model}getProvider(){return"openai"}getDimensions(){return this.dimensions}async testApiKey(t){try{return(await(0,B.requestUrl)({url:D,method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,input:"test"})})).status===200}catch(e){return!1}}setApiKey(t){this.apiKey=t}async callOpenAI(t){if(!this.apiKey)throw new Error("OpenAI API key not configured");let e=t.map(i=>{let s=i.trim();return s.length>0?s:" "});try{let i=await(0,B.requestUrl)({url:D,method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,input:e})});if(i.status!==200)throw new Error(`OpenAI API error: ${i.status}`);return i.json}catch(i){throw i instanceof Error?new Error(`OpenAI embedding failed: ${i.message}`):i}}};var p=require("obsidian");var O="1.0.0",X={storagePath:"09_Embedded",embeddingsFolder:"embeddings"},x=class{constructor(t,e){this.app=t;this.indexCache=null;this.config={...X,...e}}async initialize(){let t=this.config.storagePath,e=`${t}/${this.config.embeddingsFolder}`;await this.ensureFolder(t),await this.ensureFolder(e);let i=this.getIndexPath();await this.fileExists(i)||await this.saveIndex(this.createEmptyIndex())}async save(t){let e=this.getEmbeddingPath(t.noteId),i=$(t),s=JSON.stringify(i,null,2);await this.writeFile(e,s),this.invalidateIndexCache()}async saveBatch(t){for(let e of t)await this.save(e)}async findById(t){let e=this.getEmbeddingPath(t);if(!await this.fileExists(e))return null;try{let i=await this.readFile(e),s=JSON.parse(i);return A(s)}catch(i){return null}}async findByPath(t){let e=await this.getIndex();for(let[i,s]of Object.entries(e.notes))if(s.path===t)return this.findById(i);return null}async findAll(){let t=await this.getIndex(),e=[];for(let i of Object.keys(t.notes)){let s=await this.findById(i);s&&e.push(s)}return e}async delete(t){let e=this.getEmbeddingPath(t);await this.deleteFile(e),this.invalidateIndexCache()}async exists(t){let e=this.getEmbeddingPath(t);return this.fileExists(e)}async getContentHash(t){var i;return((i=(await this.getIndex()).notes[t])==null?void 0:i.contentHash)||null}async updateIndex(){let t=`${this.config.storagePath}/${this.config.embeddingsFolder}`,e=this.app.vault.getAbstractFileByPath(t);if(!(e instanceof p.TFolder)){await this.saveIndex(this.createEmptyIndex());return}let i={},s="",o=0;for(let a of e.children)if(a instanceof p.TFile&&a.extension==="json")try{let c=await this.app.vault.read(a),m=A(JSON.parse(c));i[m.noteId]={path:m.notePath,contentHash:m.contentHash,updatedAt:m.updatedAt.toISOString()},s||(s=m.model),o||(o=m.dimensions)}catch(c){}let n={version:O,totalNotes:Object.keys(i).length,lastUpdated:new Date().toISOString(),model:s,dimensions:o,notes:i};await this.saveIndex(n)}async getIndex(){if(this.indexCache)return this.indexCache;let t=this.getIndexPath();if(!await this.fileExists(t)){let e=this.createEmptyIndex();return this.indexCache=e,e}try{let e=await this.readFile(t),i=JSON.parse(e);return this.indexCache=i,i}catch(e){let i=this.createEmptyIndex();return this.indexCache=i,i}}async count(){return(await this.getIndex()).totalNotes}async clear(){let t=`${this.config.storagePath}/${this.config.embeddingsFolder}`,e=this.app.vault.getAbstractFileByPath(t);if(e instanceof p.TFolder)for(let i of e.children)i instanceof p.TFile&&await this.app.vault.delete(i);await this.saveIndex(this.createEmptyIndex())}getIndexPath(){return`${this.config.storagePath}/index.json`}getEmbeddingPath(t){let e=t.replace(/[^a-zA-Z0-9-_]/g,"_");return`${this.config.storagePath}/${this.config.embeddingsFolder}/${e}.json`}createEmptyIndex(){return{version:O,totalNotes:0,lastUpdated:new Date().toISOString(),model:"",dimensions:0,notes:{}}}async saveIndex(t){let e=this.getIndexPath(),i=JSON.stringify(t,null,2);await this.writeFile(e,i),this.indexCache=t}invalidateIndexCache(){this.indexCache=null}async ensureFolder(t){this.app.vault.getAbstractFileByPath(t)||await this.app.vault.createFolder(t)}async fileExists(t){return this.app.vault.getAbstractFileByPath(t)instanceof p.TFile}async readFile(t){let e=this.app.vault.getAbstractFileByPath(t);if(!(e instanceof p.TFile))throw new Error(`File not found: ${t}`);return this.app.vault.read(e)}async writeFile(t,e){let i=this.app.vault.getAbstractFileByPath(t);i instanceof p.TFile?await this.app.vault.modify(i,e):await this.app.vault.create(t,e)}async deleteFile(t){let e=this.app.vault.getAbstractFileByPath(t);e instanceof p.TFile&&await this.app.vault.delete(e)}};var U=require("obsidian"),w=class{constructor(t){this.app=t}async findById(t){let e=this.app.vault.getMarkdownFiles();for(let i of e)if(this.generateNoteId(i.path)===t)return this.fileToNoteContent(i);return null}async findByPath(t){let e=this.app.vault.getAbstractFileByPath(t);return e instanceof U.TFile?this.fileToNoteContent(e):null}async findAllMarkdownNotes(){let t=this.app.vault.getMarkdownFiles(),e=[];for(let i of t){let s=await this.fileToNoteContent(i);s&&e.push(s)}return e}async findByFolder(t){let e=this.app.vault.getMarkdownFiles(),i=[];for(let s of e)if(s.path.startsWith(t+"/")){let o=await this.fileToNoteContent(s);o&&i.push(o)}return i}async findAllExcluding(t){let e=this.app.vault.getMarkdownFiles(),i=[];for(let s of e)if(!t.some(n=>s.path.startsWith(n+"/")||s.path===n)){let n=await this.fileToNoteContent(s);n&&i.push(n)}return i}async exists(t){return await this.findById(t)!==null}generateNoteId(t){let e=t.replace(/\.md$/,"");return this.simpleHash(e)}async fileToNoteContent(t){try{let e=await this.app.vault.cachedRead(t);return{noteId:this.generateNoteId(t.path),path:t.path,title:t.basename,content:e,modifiedAt:new Date(t.stat.mtime)}}catch(e){return null}}simpleHash(t){let e=0;for(let i=0;i<t.length;i++){let s=t.charCodeAt(i);e=(e<<5)-e+s,e=e&e}return Math.abs(e).toString(16).padStart(8,"0")}};var H={openaiApiKey:"",storagePath:"09_Embedded",excludedFolders:["06_Meta","Templates"],autoEmbed:!0,autoEmbedDelay:5e3,model:"text-embedding-3-small"};var l=require("obsidian");var V=require("obsidian"),P=class extends V.Modal{constructor(e,i){super(e);this.progressEl=null;this.progressFillEl=null;this.progressStatusEl=null;this.progressPercentEl=null;this.closeBtn=null;this.modalTitle=i}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("vault-embeddings-progress-modal"),e.createEl("h2",{text:this.modalTitle}),this.progressEl=e.createDiv({cls:"progress-section"}),this.createProgressUI();let i=e.createDiv({cls:"progress-buttons"});i.style.marginTop="20px",i.style.textAlign="center",this.closeBtn=i.createEl("button",{text:"Close"}),this.closeBtn.disabled=!0,this.closeBtn.addEventListener("click",()=>this.close())}createProgressUI(){if(!this.progressEl)return;this.progressEl.empty();let e=this.progressEl.createDiv({cls:"progress-container"});e.style.marginTop="15px",this.progressStatusEl=e.createEl("p",{text:"Preparing..."}),this.progressStatusEl.style.marginBottom="10px";let i=e.createDiv({cls:"progress-bar"});i.style.width="100%",i.style.height="20px",i.style.backgroundColor="var(--background-modifier-border)",i.style.borderRadius="10px",i.style.overflow="hidden",i.style.position="relative",this.progressFillEl=i.createDiv({cls:"progress-fill"}),this.progressFillEl.setCssStyles({width:"0%",height:"100%",backgroundColor:"var(--interactive-accent)",transition:"width 0.3s ease",position:"absolute",left:"0",top:"0"}),this.progressPercentEl=e.createEl("p",{text:"0%"}),this.progressPercentEl.style.textAlign="center",this.progressPercentEl.style.marginTop="10px"}updateProgress(e){this.progressFillEl&&this.progressFillEl.setCssStyles({width:`${e.percentage}%`}),this.progressStatusEl&&(this.progressStatusEl.textContent=e.message),this.progressPercentEl&&(this.progressPercentEl.textContent=`${e.current} / ${e.total} (${e.percentage}%)`)}setComplete(e){this.progressStatusEl&&(this.progressStatusEl.textContent=e),this.progressFillEl&&this.progressFillEl.setCssStyles({width:"100%",backgroundColor:"var(--interactive-success)"}),this.progressPercentEl&&(this.progressPercentEl.textContent="100%"),this.closeBtn&&(this.closeBtn.disabled=!1,this.closeBtn.focus())}setError(e){this.progressStatusEl&&(this.progressStatusEl.textContent=e,this.progressStatusEl.style.color="var(--text-error)"),this.progressFillEl&&this.progressFillEl.setCssStyles({backgroundColor:"var(--text-error)"}),this.closeBtn&&(this.closeBtn.disabled=!1,this.closeBtn.focus())}onClose(){this.contentEl.empty()}};var k=class extends l.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Vault Embeddings Settings"}),t.createEl("h3",{text:"API Settings"}),new l.Setting(t).setName("OpenAI API Key").setDesc("API key for generating embeddings (text-embedding-3-small)").addText(i=>{i.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async s=>{this.plugin.settings.openaiApiKey=s,await this.plugin.saveSettings()}),i.inputEl.type="password",i.inputEl.style.width="300px"}).addButton(i=>{i.setButtonText("Test").onClick(async()=>{if(!this.plugin.settings.openaiApiKey){new l.Notice("Please enter an API key first");return}i.setDisabled(!0),i.setButtonText("Testing...");try{await this.plugin.testApiKey()?new l.Notice("API key is valid!"):new l.Notice("API key is invalid")}catch(s){new l.Notice("Test failed: "+(s instanceof Error?s.message:"Unknown error"))}finally{i.setDisabled(!1),i.setButtonText("Test")}})}),t.createEl("h3",{text:"Storage Settings"}),new l.Setting(t).setName("Storage Folder").setDesc("Folder to store embedding data (will be created if not exists)").addText(i=>i.setPlaceholder("09_Embedded").setValue(this.plugin.settings.storagePath).onChange(async s=>{this.plugin.settings.storagePath=s||"09_Embedded",await this.plugin.saveSettings()})),new l.Setting(t).setName("Excluded Folders").setDesc("Folders to exclude from embedding (comma-separated)").addText(i=>i.setPlaceholder("06_Meta, Templates").setValue(this.plugin.settings.excludedFolders.join(", ")).onChange(async s=>{this.plugin.settings.excludedFolders=s.split(",").map(o=>o.trim()).filter(o=>o.length>0),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Auto Embedding"}),new l.Setting(t).setName("Auto Embed").setDesc("Automatically create/update embeddings when notes are created or modified").addToggle(i=>i.setValue(this.plugin.settings.autoEmbed).onChange(async s=>{this.plugin.settings.autoEmbed=s,await this.plugin.saveSettings()})),new l.Setting(t).setName("Auto Embed Delay").setDesc("Delay before auto-embedding after modification (in seconds)").addSlider(i=>i.setLimits(1,30,1).setValue(this.plugin.settings.autoEmbedDelay/1e3).setDynamicTooltip().onChange(async s=>{this.plugin.settings.autoEmbedDelay=s*1e3,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Actions"}),new l.Setting(t).setName("Embed All Notes").setDesc("Generate embeddings for all notes in the vault").addButton(i=>{i.setButtonText("Embed All").setCta().onClick(async()=>{if(!this.plugin.isConfigured()){new l.Notice("Please configure API key first");return}let s=new P(this.app,"Embedding All Notes");s.open();try{let o=await this.plugin.embedAllNotes(n=>{let a=n.completed+n.failed,c=n.completed-n.skipped,m=n.total>0?Math.round(a/n.total*100):0;s.updateProgress({current:a,total:n.total,message:`Processing: ${c} / ${a} (${n.skipped} skipped, ${n.failed} failed)`,percentage:m})});s.setComplete(`\u2705 Complete! ${o.success} embedded, ${o.skipped} skipped, ${o.failed} failed`)}catch(o){let n=o instanceof Error?o.message:"Unknown error";s.setError(`\u274C Failed: ${n}`)}})}),new l.Setting(t).setName("Update Stale Embeddings").setDesc("Only update embeddings for modified notes").addButton(i=>{i.setButtonText("Update Stale").onClick(async()=>{if(!this.plugin.isConfigured()){new l.Notice("Please configure API key first");return}let s=new P(this.app,"Updating Stale Embeddings");s.open();try{let o=await this.plugin.embedStaleNotes(n=>{let a=n.completed+n.failed,c=n.completed-n.skipped,m=n.total>0?Math.round(a/n.total*100):0;s.updateProgress({current:a,total:n.total,message:`Checking: ${c} updated / ${a} checked (${n.skipped} unchanged)`,percentage:m})});s.setComplete(`\u2705 Complete! ${o.updated} updated, ${o.skipped} skipped, ${o.failed} failed`)}catch(o){let n=o instanceof Error?o.message:"Unknown error";s.setError(`\u274C Failed: ${n}`)}})}),new l.Setting(t).setName("Clear All Embeddings").setDesc("Delete all stored embeddings").addButton(i=>{i.setButtonText("Clear All").setWarning().onClick(async()=>{if(confirm("Are you sure you want to delete all embeddings?"))try{await this.plugin.clearAllEmbeddings(),new l.Notice("All embeddings cleared")}catch(o){new l.Notice("Clear failed: "+(o instanceof Error?o.message:"Unknown error"))}})}),t.createEl("h3",{text:"Statistics"});let e=t.createDiv({cls:"vault-embeddings-stats"});this.displayStats(e)}async displayStats(t){t.empty();try{let e=await this.plugin.getStats();t.createEl("p",{text:`Total embeddings: ${e.totalEmbeddings}`}),t.createEl("p",{text:`Model: ${e.model||"Not set"}`}),t.createEl("p",{text:`Provider: ${e.provider||"Not set"}`}),t.createEl("p",{text:`Dimensions: ${e.dimensions||"Not set"}`}),t.createEl("p",{text:`Last updated: ${e.lastUpdated||"Never"}`})}catch(e){t.createEl("p",{text:"Unable to load statistics"})}}};var F=class extends d.Plugin{constructor(){super(...arguments);this.embeddingProvider=null;this.embeddingRepository=null;this.noteRepository=null;this.embeddingService=null;this.autoEmbedDebounced=null}async onload(){console.log("Loading Vault Embeddings Plugin"),await this.loadSettings(),await this.initializeServices(),this.addCommand({id:"embed-current-note",name:"Embed current note",callback:()=>this.embedCurrentNote()}),this.addCommand({id:"embed-all-notes",name:"Embed all notes",callback:()=>this.embedAllNotesCommand()}),this.addCommand({id:"update-stale-embeddings",name:"Update stale embeddings",callback:()=>this.updateStaleCommand()}),this.addCommand({id:"show-embedding-stats",name:"Show embedding statistics",callback:()=>this.showStatsCommand()}),this.addSettingTab(new k(this.app,this)),this.registerVaultEvents(),this.addRibbonIcon("database","Vault Embeddings",()=>{this.showStatsCommand()})}async onunload(){console.log("Unloading Vault Embeddings Plugin")}async loadSettings(){this.settings=Object.assign({},H,await this.loadData())}async saveSettings(){await this.saveData(this.settings),await this.initializeServices()}async initializeServices(){if(!this.settings.openaiApiKey){console.log("Vault Embeddings: API key not configured");return}try{this.embeddingProvider=new v(this.settings.openaiApiKey,this.settings.model),this.embeddingRepository=new x(this.app,{storagePath:this.settings.storagePath}),await this.embeddingRepository.initialize(),this.noteRepository=new w(this.app),this.embeddingService=new E(this.embeddingProvider,this.embeddingRepository,this.noteRepository),this.setupAutoEmbed(),console.log("Vault Embeddings: Services initialized")}catch(e){console.error("Failed to initialize services:",e)}}setupAutoEmbed(){this.autoEmbedDebounced&&(this.autoEmbedDebounced=null),this.settings.autoEmbed&&this.embeddingService&&(this.autoEmbedDebounced=(0,d.debounce)(async e=>{if(!(!this.embeddingService||!this.noteRepository||this.settings.excludedFolders.some(s=>e.path.startsWith(s+"/"))))try{let s=this.noteRepository.generateNoteId(e.path);await this.embeddingService.embedNote(s),console.log(`Auto-embedded: ${e.path}`)}catch(s){console.error(`Auto-embed failed for ${e.path}:`,s)}},this.settings.autoEmbedDelay,!0))}registerVaultEvents(){this.registerEvent(this.app.vault.on("modify",e=>{e instanceof d.TFile&&e.extension==="md"&&this.autoEmbedDebounced&&this.autoEmbedDebounced(e)})),this.registerEvent(this.app.vault.on("create",e=>{e instanceof d.TFile&&e.extension==="md"&&this.autoEmbedDebounced&&this.autoEmbedDebounced(e)})),this.registerEvent(this.app.vault.on("delete",async e=>{if(e instanceof d.TFile&&e.extension==="md"&&this.embeddingService&&this.noteRepository)try{let i=this.noteRepository.generateNoteId(e.path);await this.embeddingService.deleteEmbedding(i),console.log(`Deleted embedding: ${e.path}`)}catch(i){console.error(`Failed to delete embedding for ${e.path}:`,i)}})),this.registerEvent(this.app.vault.on("rename",async(e,i)=>{if(e instanceof d.TFile&&e.extension==="md"&&this.embeddingService&&this.noteRepository)try{let s=this.noteRepository.generateNoteId(i);await this.embeddingService.deleteEmbedding(s),this.autoEmbedDebounced&&this.autoEmbedDebounced(e)}catch(s){console.error(`Failed to handle rename for ${e.path}:`,s)}}))}isConfigured(){return!!this.settings.openaiApiKey&&!!this.embeddingService}async testApiKey(){return this.embeddingProvider?this.embeddingProvider.testApiKey(this.settings.openaiApiKey):!1}async embedAllNotes(e){if(!this.embeddingService)throw new Error("Embedding service not initialized");return this.embeddingService.embedAllNotes(this.settings.excludedFolders,e)}async embedStaleNotes(e){if(!this.embeddingService)throw new Error("Embedding service not initialized");return this.embeddingService.embedStaleNotes(this.settings.excludedFolders,e)}async clearAllEmbeddings(){if(!this.embeddingService)throw new Error("Embedding service not initialized");await this.embeddingService.clearAllEmbeddings()}async getStats(){return this.embeddingService?this.embeddingService.getStats():{totalEmbeddings:0,model:this.settings.model,provider:"openai",dimensions:1536,lastUpdated:null}}async searchSimilar(e,i){return this.embeddingService?this.embeddingService.searchSimilar(e,i):[]}async findSimilarToNote(e,i){if(!this.embeddingService||!this.noteRepository)return[];let s=this.noteRepository.generateNoteId(e);return this.embeddingService.findSimilarToNote(s,i)}async embedCurrentNote(){if(!this.embeddingService||!this.noteRepository){new d.Notice("Embedding service not configured");return}let e=this.app.workspace.getActiveFile();if(!e||e.extension!=="md"){new d.Notice("No markdown file active");return}try{let i=this.noteRepository.generateNoteId(e.path);(await this.embeddingService.embedNote(i)).wasUpdated?new d.Notice(`Embedded: ${e.basename}`):new d.Notice(`Already up to date: ${e.basename}`)}catch(i){new d.Notice("Embedding failed: "+(i instanceof Error?i.message:"Unknown error"))}}async embedAllNotesCommand(){if(!this.isConfigured()){new d.Notice("Please configure API key first");return}new d.Notice("Starting embedding...");try{let e=await this.embedAllNotes(i=>{console.log(`Progress: ${i.completed}/${i.total}`)});new d.Notice(`Complete! ${e.success} embedded, ${e.skipped} skipped, ${e.failed} failed`)}catch(e){new d.Notice("Embedding failed: "+(e instanceof Error?e.message:"Unknown error"))}}async updateStaleCommand(){if(!this.isConfigured()){new d.Notice("Please configure API key first");return}new d.Notice("Updating stale embeddings...");try{let e=await this.embedStaleNotes();new d.Notice(`Complete! ${e.updated} updated, ${e.skipped} skipped, ${e.failed} failed`)}catch(e){new d.Notice("Update failed: "+(e instanceof Error?e.message:"Unknown error"))}}async showStatsCommand(){let e=await this.getStats();new d.Notice(`Embeddings: ${e.totalEmbeddings}
Model: ${e.model}
Last updated: ${e.lastUpdated||"Never"}`)}};
